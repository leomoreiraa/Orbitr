<div class="h-full bg-[var(--bg)] text-[var(--text)]">
  <div class="board-container">

    <!-- Formulário de nova coluna -->
    <div *ngIf="showNewColumnForm()" class="absolute top-4 left-4 right-4 z-10 p-4 bg-[var(--surface)] rounded-xl border border-[var(--border)] shadow-sm">
      <form (ngSubmit)="addColumn()" class="flex items-center gap-3">
        <input type="text" 
               [ngModel]="newColumnTitle()" 
               (ngModelChange)="newColumnTitle.set($event)" 
               name="columnTitle" 
               placeholder="Nome da nova coluna" 
               class="input flex-1" />
        <button type="submit" class="btn">Adicionar</button>
        <button type="button" 
                (click)="showNewColumnForm.set(false); newColumnTitle.set('')" 
                class="btn-ghost p-2 !w-10 !h-10">
          ✕
        </button>
      </form>
    </div>

    <!-- Estado vazio -->
    <div *ngIf="currentBoardId() && columns().length===0" class="absolute inset-0 flex items-center justify-center">
      <div class="text-center max-w-md">
        <div class="w-20 h-20 mx-auto mb-4 bg-[var(--bg-soft)] rounded-full flex items-center justify-center text-4xl">
          📋
        </div>
        <h3 class="text-xl font-semibold text-[var(--text)] mb-2">Board vazio</h3>
        <p class="text-[var(--text-soft)] mb-6">Comece criando sua primeira coluna para organizar suas tarefas.</p>
        <button type="button" 
                (click)="showNewColumnForm.set(true); newColumnTitle.set('A Fazer')" 
                class="btn">
          Criar primeira coluna
        </button>
        <!-- Espaço reservado para mensagens -->
      </div>
    </div>

    <!-- Área das colunas -->
    <div *ngIf="columns().length > 0">

      <!-- Horizontal swipeable columns for tablet/desktop -->
      <div class="columns-wrapper hidden sm:flex" [attr.data-columns]="columns().length">
        <div *ngFor="let col of columns()" 
           [attr.data-column-id]="col.id" 
           [attr.data-task-count]="tasksByColumn()[col.id]?.length || 0"
           class="column drop-zone"
           [class.drag-over]="dropZoneColumn() === col.id">
        
        <!-- Cabeçalho da coluna -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3 flex-1">
            <span *ngIf="editingColumnId()!==col.id" 
                    (dblclick)="startEditColumn(col)" 
                    tabindex="0" 
                    (keydown.enter)="startEditColumn(col)" 
                    class="font-semibold text-[var(--text)] cursor-pointer hover:text-[var(--brand)] transition">
                {{ col.titulo }}
              </span>
    <input *ngIf="editingColumnId()===col.id" 
      type="text" 
      [value]="tempEditText()" 
      (keydown.enter)="commitEditColumn(col)" 
      (blur)="commitEditColumn(col)" 
      (keydown.escape)="cancelEditColumn()" 
      (input)="onEditInput($event)" 
      class="input flex-1 text-[var(--text)]" />
              
              <span class="px-2 py-1 bg-[var(--bg-soft)] text-[var(--text-soft)] rounded-full text-xs font-medium">
                {{ (tasksByColumn()[col.id] || []).length }}
              </span>
            </div>
            
            <div class="flex items-center gap-2">
              <button type="button" 
                      (click)="quickAddInColumn(col)" 
                      class="btn-ghost !w-8 !h-8 text-[var(--brand)]" 
                      title="Adicionar tarefa">
                ＋
              </button>
              <button type="button" 
                      (click)="deleteColumn(col)" 
                      class="btn-ghost !w-8 !h-8 text-red-500 hover:text-red-600" 
                      title="Excluir coluna">
                ✕
              </button>
            </div>
          </div>
          
          <!-- Lista de tarefas -->
          <div class="column-content">
            <div *ngFor="let t of tasksByColumn()[col.id]" 
                 class="task-card-container group"
                 [class.opacity-50]="isDragging() && draggedTask()?.id === t.id"
                 [attr.data-task-id]="t.id">
              
              <!-- Card da task -->
              <div *ngIf="editingTaskId()!==t.id" 
                   class="task-card bg-[var(--surface)] rounded-xl shadow-sm border border-[var(--border)] hover:shadow-md transition-all duration-200"
                   [style.border-left-color]="getPriorityBorderColor(t.prioridade)"
                   [style.border-left-width]="'4px'"
                   (click)="onTaskClick(t, $event)"
                   (mousedown)="onTaskMouseDown($event, t)"
                   (dblclick)="startEditTask(t)">
                
                <div class="p-4">
                  <div class="flex items-start justify-between gap-3 mb-3">
                    <!-- Drag handle -->
                    <div class="drag-handle w-5 h-5 cursor-grab hover:cursor-grabbing flex-shrink-0 flex items-center justify-center text-[var(--text-soft)] hover:text-[var(--text)] transition opacity-0 group-hover:opacity-100"
                         title="Arraste para mover">
                      ⋮⋮
                    </div>
                    
                    <!-- Título da task -->
                    <div class="flex-1 min-w-0">
                      <h4 class="font-medium text-[var(--text)] line-clamp-2 mb-1"
                          [class.opacity-60]="t.status==='CONCLUIDA'">
                        {{ t.titulo }}
                      </h4>
                      <p class="text-xs text-[var(--text-soft)] uppercase tracking-wide font-medium">
                        {{ col.titulo }}
                      </p>
                    </div>
                    
                    <!-- Botão de notas com novo ícone -->
                    <button (click)="toggleNotesPanel(t, $event)" 
                            (mousedown)="stopPropagation($event)"
                            (mouseup)="stopPropagation($event)"
                            (touchstart)="stopPropagation($event)"
                            class="notes-button w-8 h-8 rounded-lg bg-[var(--brand)] hover:bg-[var(--brand-hover)] text-white flex items-center justify-center text-sm transition-all shadow-sm hover:shadow-md opacity-0 group-hover:opacity-100"
                            title="Notas"
                            type="button">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                      </svg>
                    </button>
                  </div>
                  
                  <!-- Tags -->
                  <div *ngIf="t.tags && t.tags.length" class="flex flex-wrap gap-1 mb-3">
                    <span *ngFor="let tag of t.tags" 
                          class="px-2 py-1 rounded-full bg-[var(--bg-soft)] text-[var(--text-soft)] text-xs font-medium">
                      {{ tag }}
                    </span>
                  </div>
                  
                  <!-- Indicadores na parte inferior -->
                  <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                      <!-- Indicador de prazo -->
                      <div *ngIf="getDeadlineStatus(t)" 
                           class="w-3 h-3 rounded-full"
                           [style.background-color]="getDeadlineColor(getDeadlineStatus(t))"
                           [title]="t.dueDate ? ('Prazo: ' + (t.dueDate | date:'dd/MM/yyyy HH:mm')) : ''">
                      </div>
                    </div>
                    
                    <!-- Status ou outras informações -->
                    <span *ngIf="t.status==='CONCLUIDA'" 
                          class="text-xs text-green-600 font-medium">
                      ✓ Concluída
                    </span>
                  </div>
                </div>
              </div>
              
              <!-- Campo de edição -->
              <div *ngIf="editingTaskId()===t.id" class="bg-[var(--surface)] rounded-xl border border-[var(--border)] p-4">
                <input type="text" 
                       [value]="tempEditText()" 
                       (keydown.enter)="commitEditTask(t)" 
                       (blur)="commitEditTask(t)" 
                       (keydown.escape)="cancelEditTask()" 
                       (input)="onEditInput($event)" 
                       class="input w-full text-[var(--text)]" />
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mobile stacked columns (single-column scroll) -->
      <div class="mobile-board-list sm:hidden p-3 space-y-4">
        <div *ngFor="let col of columns()" 
             [attr.data-column-id]="col.id" 
             [attr.data-task-count]="tasksByColumn()[col.id]?.length || 0"
             class="column drop-zone w-full">
          <!-- Reuse the same inner structure as above for header and tasks -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3 flex-1">
              <span *ngIf="editingColumnId()!==col.id" 
                      (dblclick)="startEditColumn(col)" 
                      tabindex="0" 
                      (keydown.enter)="startEditColumn(col)" 
                      class="font-semibold text-[var(--text)] cursor-pointer hover:text-[var(--brand)] transition">
                  {{ col.titulo }}
                </span>
      <input *ngIf="editingColumnId()===col.id" 
        type="text" 
        [value]="tempEditText()" 
        (keydown.enter)="commitEditColumn(col)" 
        (blur)="commitEditColumn(col)" 
        (keydown.escape)="cancelEditColumn()" 
        (input)="onEditInput($event)" 
        class="input flex-1 text-[var(--text)]" />
              
              <span class="px-2 py-1 bg-[var(--bg-soft)] text-[var(--text-soft)] rounded-full text-xs font-medium">
                {{ (tasksByColumn()[col.id] || []).length }}
              </span>
            </div>
            <div class="flex items-center gap-2">
              <button type="button" 
                      (click)="quickAddInColumn(col)" 
                      class="btn-ghost !w-8 !h-8 text-[var(--brand)]" 
                      title="Adicionar tarefa">
                ＋
              </button>
              <button type="button" 
                      (click)="deleteColumn(col)" 
                      class="btn-ghost !w-8 !h-8 text-red-500 hover:text-red-600" 
                      title="Excluir coluna">
                ✕
              </button>
            </div>
          </div>

          <div class="column-content">
            <div *ngFor="let t of tasksByColumn()[col.id]" class="task-card-container group">
              <div *ngIf="editingTaskId()!==t.id" 
                   class="task-card bg-[var(--surface)] rounded-xl shadow-sm border border-[var(--border)] hover:shadow-md transition-all duration-200"
                   [style.border-left-color]="getPriorityBorderColor(t.prioridade)"
                   [style.border-left-width]="'4px'"
                   (click)="onTaskClick(t, $event)"
                   (mousedown)="onTaskMouseDown($event, t)"
                   (dblclick)="startEditTask(t)">
                <div class="p-3">
                  <div class="flex items-start justify-between gap-3 mb-3">
                    <div class="flex-1 min-w-0">
                      <h4 class="font-medium text-[var(--text)] line-clamp-2 mb-1">{{ t.titulo }}</h4>
                      <p class="text-xs text-[var(--text-soft)] uppercase tracking-wide font-medium">{{ col.titulo }}</p>
                    </div>
                    <button (click)="toggleNotesPanel(t, $event)" class="notes-button w-8 h-8 rounded-lg bg-[var(--brand)] text-white flex items-center justify-center text-sm">✎</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Notepad flutuante -->
<app-task-notepad 
  *ngIf="activeNotepad()"
  [task]="activeNotepad()!.task"
  [position]="activeNotepad()!.position"
  (onClose)="onNotepadClose()">
</app-task-notepad>
